<html>
    <body>
        <fieldset>
            <legend>Perf test</legend>
            <p>
                <button onclick="perf('data/random.bin', '#perf-uncompressed', false)">Start</button>
                <strong>Uncompressed file</strong>
                <span id='perf-uncompressed'></span>
            </p>
            <p>
                <button onclick="perf('data/random.bin.br', '#perf-brotli', false)">Start</button>
                <strong>Brotli compressed</strong>
                <span id='perf-brotli'></span>
            </p>
            <p>
                <button onclick="perf('data/random.bin.xz', '#perf-xz', true)">Start</button>
                <strong>XZ compressed</strong>
                <span id='perf-xz'></span>
            </p>
        </fieldset>

        <script type='module'>
            import { XzReadableStream } from './lib/xzwasm.js';
    
            const wasmBytes = await (await fetch('lib/xzwasm.wasm')).arrayBuffer();
            const wasmResponse = new Response(wasmBytes, { headers: { 'Content-Type': 'application/wasm' } });
            const module = await WebAssembly.instantiateStreaming(wasmResponse, {});
    
            window.perf = async function(urlToFetch, outputElemSelector, useXz) {
                const startTime = new Date();
                const originalResponse = await fetch(urlToFetch);
                const response = useXz
                    ? new Response(new XzReadableStream(module.instance, originalResponse.body),
                        { headers: { } })
                    : originalResponse;
                const allBytes = await response.arrayBuffer();
                const duration = new Date().valueOf() - startTime.valueOf();
                const message = `Fetched ${allBytes.byteLength} bytes in ${duration}ms`;
                document.querySelector(outputElemSelector).textContent = message;
            };
        </script>
    </body>
</html>
